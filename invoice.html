<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Invoice Generator â€” Fixed PDF Header</title>

  <!-- XLSX for Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root { --accent:#0b5; }
    body{font-family:Arial, sans-serif; background:#f5f5f5; margin:0; color:#111}

    /* Login */
    #loginPage{display:flex; justify-content:center; align-items:center; min-height:100vh}
    .login-box{background:#fff; padding:28px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,.12); width:320px; max-width:92vw}
    .login-box h2{margin:0 0 12px; text-align:center}
    .login-box input{width:100%; padding:12px; margin:8px 0; border:1px solid #cbd5e1; border-radius:8px; font-size:16px}
    .login-box button{width:100%; padding:12px; border:none; border-radius:8px; background:#111827; color:#fff; font-weight:700; cursor:pointer; font-size:16px}
    .login-error{color:#b91c1c; text-align:center; display:none}

    /* App container */
    #app{display:none}
    .container{max-width:980px; margin:16px auto; background:#fff; padding:15px; border-radius:6px; box-shadow:0 3px 8px rgba(0,0,0,0.1)}

    /* Header layout: logo left, center details, copy right */
    .top-header{display:flex; gap:8px; align-items:flex-start; justify-content:space-between; border-bottom:2px solid #0b0; padding-bottom:8px; margin-bottom:12px}
    .hdr-left{flex:0 0 90px; display:flex; align-items:center}
    .hdr-left img{height:72px; display:block}
    .hdr-center{flex:1; text-align:center; padding-top:4px}
    .hdr-center h1{margin:0; font-size:28px; letter-spacing:1px}
    .hdr-center .addr{font-size:12px; font-weight:600; margin-top:6px}
    .hdr-center .gst{font-size:13px; font-weight:700; margin-top:6px}
    .hdr-center .email{font-size:12px; margin-top:2px}
    .tax-invoice{margin-top:8px; font-size:20px; font-weight:800; text-decoration:underline; letter-spacing:1px}
    .hdr-right{flex:0 0 180px; text-align:right; font-size:12px}

    /* Toolbar & controls */
    .toolbar{margin-bottom:10px; display:flex; gap:6px; flex-wrap:wrap; align-items:center}
    .toolbar button{padding:8px 12px; border:none; border-radius:6px; cursor:pointer; background:#333; color:#fff; font-size:14px}
    .toolbar .clear{background:#9a3412}
    .toolbar .download{background:var(--accent)}
    .toolbar .logout{background:#8b0000; margin-left:auto}

    /* Table */
    .table-wrap{width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch}
    table{width:100%; border-collapse:collapse; margin-top:10px; font-size:13px; min-width:720px}
    table, th, td{border:1px solid #ccc}
    th, td{padding:6px; text-align:left; vertical-align:middle}
    .center{text-align:center}
    .num{text-align:right}

    /* Totals and misc */
    .right{text-align:right; margin-top:8px; font-size:13px}
    .amountWords{margin-top:5px; font-style:italic; font-size:12px}

    /* Bottom boxes */
    .bottom-grid{display:flex; gap:12px; margin-top:30px}
    .box-small{border:1px solid #000; width:30%; padding:6px; font-size:12px}
    .box-large{border:1px solid #000; width:65%; padding:10px}

    /* Payment details textarea border on-screen, hidden in export/print */
    #paymentDetails{border:1px solid #ccc; width:100%; height:80px; resize:vertical; margin-top:6px; padding:8px; box-sizing:border-box}
    .pay-head{display:flex; align-items:center; justify-content:space-between; gap:8px}

    /* small adjustments for Bill to / Address inputs (no underline) */
    #billTo, #billAddr{border:none !important; outline:none; font-size:13px}

    /* Toast */
    #toast{position:fixed; right:16px; bottom:16px; background:#166534; color:#fff; padding:10px 14px; border-radius:6px; box-shadow:0 4px 14px rgba(0,0,0,.2); opacity:0; pointer-events:none; transition:opacity .25s, transform .25s; transform:translateY(8px); z-index:9999}
    #toast.show{opacity:1; transform:translateY(0)}
    #toast.error{background:#7f1d1d}

    .cust-controls{display:flex; gap:6px; margin-top:6px; flex-wrap:wrap}

    /* export/print cleanup */
    .exporting .toolbar,
    .exporting .desc,
    .exporting button.logout,
    .exporting .cust-controls,
    .exporting #customerSelect,
    .exporting #copyTypeSelect,
    .exporting .pay-controls,
    .exporting td:last-child,
    .exporting th:last-child{display:none !important}
    .exporting table, .exporting th, .exporting td{border:none}
    .exporting input, .exporting select, .exporting textarea{border:none}
    .exporting .descPrint{display:inline !important}
    .exporting .container{box-shadow:none; border-radius:0}
    .exporting .screen-only{display:none !important}
    .exporting .print-only{display:block !important}
    .exporting #paymentDetails{border:none !important}

    @media print{
      body{background:#fff}
      .toolbar, .desc, button.logout, .cust-controls, #customerSelect, #copyTypeSelect, .pay-controls, td:last-child, th:last-child, .screen-only input, .screen-only select{display:none !important}
      table, th, td{border:none}
      input, select, textarea{border:none}
      #paymentDetails{border:none !important}
      .descPrint{display:inline !important}
      .container{box-shadow:none; border-radius:0}
      .screen-only{display:none !important}
      .print-only{display:block !important}
      @page{size:auto; margin:12mm}
    }

    /* mobile adjustments */
    @media (max-width:820px){
      .container{margin:8px; padding:12px}
      .hdr-left img{height:52px}
      .hdr-center h1{font-size:20px}
      .tax-invoice{font-size:16px}
      .hdr-right{flex:0 0 140px; font-size:12px}
      .table-wrap{margin-top:8px}
      table{min-width:680px}
      .box-small{width:36%}
      .box-large{width:62%}
      .bottom-grid{flex-direction:row; gap:10px}
    }
    @media (max-width:540px){
      .top-header{flex-direction:column; gap:8px; align-items:stretch}
      .hdr-left{order:1}
      .hdr-center{order:2; text-align:center}
      .hdr-right{order:3; text-align:left}
      .hdr-left img{height:48px}
      .top-header .hdr-right{align-self:flex-end}
      .bottom-grid{flex-direction:column}
      .box-small, .box-large{width:100%}
      .toolbar button{flex:1 1 140px}
    }
  </style>
</head>
<body>
  <!-- Login -->
  <div id="loginPage">
    <div class="login-box">
      <h2>Login</h2>
      <input type="text" id="username" placeholder="Username" autocomplete="username">
      <input type="password" id="password" placeholder="Password" autocomplete="current-password">
      <button id="loginBtn" type="submit">Login</button>
      <p class="login-error" id="loginError">Invalid credentials</p>
    </div>
  </div>

  <!-- App -->
  <div id="app">
    <div id="toast"></div>
    <div class="container" id="invoiceRoot">

      <!-- TOP HEADER: logo left, center info, copy right -->
      <div class="top-header">
        <div class="hdr-left">
          <img id="logoImgScreen" src="logo.png" alt="Royal Roots Logo" crossorigin="anonymous">
        </div>

        <div class="hdr-center">
          <h1>ROYAL ROOTS PTE. LTD.</h1>
          <div class="addr">134 JURONG GATEWAY ROAD, #04-309N, SINGAPORE 600134</div>
          <div class="gst">GST Reg No: 202529214R</div>
          <div class="email">Email: contactroyalroots@gmail.com</div>
          <div class="tax-invoice">TAX INVOICE</div>
        </div>

        <div class="hdr-right">
          <div style="font-size:12px; font-weight:700;">(Customer Copy)</div>
          <div style="margin-top:6px">Invoice #: <input type="text" id="invNo" value="INV-0000001" style="border:none; border-bottom:1px dotted #666; font-size:12px;"></div>
          <div style="margin-top:6px">Invoice date: <input type="date" id="invDate" style="font-size:12px;"></div>
          <div style="margin-top:6px">
            <select id="copyTypeSelect" onchange="updateCopyType()">
              <option value="Customer Copy" selected>Customer Copy</option>
              <option value="Original Copy">Original Copy</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Print header (clean) -->
      <div id="printHeader" class="print-only" style="display:none; margin-bottom:12px;">
        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
          <div style="display:flex; align-items:center;">
            <img id="logoImgPrint" src="logo.png" alt="Royal Roots Logo" style="height:52px; margin-right:8px;" crossorigin="anonymous">
            <div>
              <div style="font-weight:800; font-size:16px;">ROYAL ROOTS PTE. LTD.</div>
              <div style="font-size:12px; font-weight:600;">134 JURONG GATEWAY ROAD, #04-309N, SINGAPORE 600134</div>
              <div style="font-size:12px; font-weight:700; margin-top:4px;">GST Reg No: 202529214R</div>
              <div style="font-size:12px;">Email: contactroyalroots@gmail.com</div>
            </div>
          </div>
          <div style="text-align:right; font-size:12px;">
            <div style="font-size:14px; font-weight:700;">TAX INVOICE</div>
            <div><b>Invoice #:</b> <span id="phInvNo">INV-0000001</span></div>
            <div><b>Invoice date:</b> <span id="phInvDate">--/--/----</span></div>
            <div style="margin-top:6px;"><b><span id="phCopyType">(Customer Copy)</span></b></div>
          </div>
        </div>
      </div>

      <!-- Customer section -->
      <div style="margin-bottom:12px; font-size:13px;">
        <div style="margin-top:6px;">
          <b>Bill to:</b> <input type="text" id="billTo" placeholder="Customer Name" style="font-size:13px; max-width:100%;">
        </div>
        <div style="margin-top:6px;">
          <b>Address:</b> <input type="text" id="billAddr" placeholder="Address" style="font-size:13px; width:80%; max-width:100%;">
        </div>
        <div class="cust-controls">
          <select id="customerSelect" onchange="onSelectCustomer(this)">
            <option value="">-- Select Customer --</option>
          </select>
          <input type="file" id="uploadCustomers" accept=".csv" style="display:none" />
          <button onclick="document.getElementById('uploadCustomers').click()">Import Customers (CSV)</button>
          <button onclick="downloadCustomersCSV()">Download Customers (CSV)</button>
        </div>
      </div>

      <!-- Toolbar -->
      <div class="toolbar">
        <button id="btnAddRow">Add Row</button>
        <button id="btnAddProduct">Add Product</button>
        <button id="btnDownloadInvCSV">Download Inventory (CSV)</button>
        <input type="file" id="uploadInventory" accept=".csv,.xlsx,.xls" style="display:none" />
        <button id="btnImportInv">Import Inventory (CSV/XLSX)</button>
        <button id="btnExportXLSX">Export Invoice (Excel)</button>
        <button class="clear" id="btnClear">Clear Data</button>
        <button class="download" id="btnPDF">Download PDF</button>
        <button class="logout" id="btnLogout">Logout</button>
      </div>

      <!-- Items table -->
      <div class="table-wrap">
        <table id="items">
          <thead>
            <tr>
              <th style="width:40px">#</th>
              <th>Description</th>
              <th style="width:60px" class="center">Qty</th>
              <th style="width:80px" class="center">Per Unit</th>
              <th style="width:90px" class="center">Unit Price ($)</th>
              <th style="width:100px" class="center">Total ($)</th>
              <th style="width:30px">â¨¯</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Totals -->
      <div class="right">
        <p><b>Subtotal:</b> <span id="subTotal">$0.00</span></p>
        <p><b>GST (9%):</b> <span id="gstAmount">$0.00</span></p>
        <p><b>Total:</b> <span id="grandTotal">$0.00</span></p>
        <div class="amountWords" id="amountWords">Amount in words: Zero Dollars Only</div>
      </div>

      <!-- Bottom boxes: reduced left box, payment on right -->
      <div class="bottom-grid">
        <div class="box-small">
          <b>Invoice Received and Verified By</b>
          <div style="height:40px;"></div>
        </div>

        <div class="box-large">
          <div class="pay-head">
            <b>Payment Details:</b>
            <div class="pay-controls">
              <select id="paymentSelect" onchange="onSelectPayment(this)">
                <option value="">-- Select Payment --</option>
              </select>
              <input type="file" id="uploadPayments" accept=".csv" style="display:none" />
              <button onclick="document.getElementById('uploadPayments').click()">Import Payments (CSV)</button>
              <button onclick="downloadPaymentsCSV()">Download Payments (CSV)</button>
            </div>
          </div>
          <textarea id="paymentDetails" placeholder="Enter payment instructions (bank, PayNow, etc.)"></textarea>
        </div>
      </div>

      <div style="text-align:center; margin-top:20px; font-size:12px;"><i>This is system Generated Invoice</i></div>
    </div>
  </div>

<script>
/* ========= NOTE =========
 This file hides the on-screen header during PDF export so the print header isn't duplicated.
 Keep logo.png next to this file.
 Login: admin / sharvil
==========================*/

/* global error toast */
function toast(msg,isError){
  var el=document.getElementById('toast');
  if(!el) return;
  el.textContent=msg;
  el.classList.toggle('error', !!isError);
  el.classList.add('show');
  setTimeout(function(){ el.classList.remove('show'); }, 1800);
}
window.onerror = function(msg){ try{ toast('Error: '+msg, true); }catch(_){} };

/* ===== LOGIN ===== */
function showApp(){
  document.getElementById('loginPage').style.display='none';
  document.getElementById('app').style.display='block';
  initInvoice();
}
function loginHandler(e){
  if(e && e.preventDefault) e.preventDefault();
  var u = (document.getElementById('username').value||'').trim();
  var p = (document.getElementById('password').value||'').trim();
  var err = document.getElementById('loginError');
  if(u==='admin' && p==='sharvil'){
    try{ localStorage.setItem('rr_logged_in','1'); }catch(_){}
    if(err) err.style.display='none';
    showApp();
    return false;
  } else {
    if(err) err.style.display='block';
    return false;
  }
}
function logout(){
  try{ localStorage.removeItem('rr_logged_in'); }catch(_){}
  location.reload();
}

/* ===== HEADER helpers ===== */
function updateCopyType(){
  var sel=document.getElementById('copyTypeSelect');
  var ph=document.getElementById('phCopyType');
  var onScreen=document.getElementById('copyTypeLabel');
  var copyLabel = '(' + (sel ? sel.value : 'Customer Copy') + ')';
  if(document.getElementById('phCopyType')) document.getElementById('phCopyType').textContent = copyLabel;
  if(document.getElementById('copyTypeLabel')) document.getElementById('copyTypeLabel').textContent = copyLabel;
}
function formatDateDDMMYYYY(iso){
  if(!iso) return '';
  var d=new Date(iso+'T00:00:00'); if(!isFinite(d)) return iso;
  var dd=('0'+d.getDate()).slice(-2), mm=('0'+(d.getMonth()+1)).slice(-2);
  return dd+'/'+mm+'/'+d.getFullYear();
}
function fillPrintHeader(){
  var invNo=(document.getElementById('invNo')||{}).value || 'INV-0000001';
  var invDate=(document.getElementById('invDate')||{}).value || '';
  var copyTxt=(document.getElementById('copyTypeSelect')||{}).value || 'Customer Copy';
  var phInvNo=document.getElementById('phInvNo'); if(phInvNo) phInvNo.textContent = invNo;
  var phInvDate=document.getElementById('phInvDate'); if(phInvDate) phInvDate.textContent = invDate?formatDateDDMMYYYY(invDate):'';
  var phCopy=document.getElementById('phCopyType'); if(phCopy) phCopy.textContent = '('+copyTxt+')';
}

/* ===== PDF export loader & call ===== */
function loadHtml2PdfIfNeeded(){
  return new Promise(function(resolve, reject){
    if(window.html2pdf){ resolve(); return; }
    var s=document.createElement('script');
    s.src='https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
    s.onload=function(){ resolve(); };
    s.onerror=function(){ reject(new Error('Failed to load html2pdf')); };
    document.head.appendChild(s);
  });
}
async function downloadPDF(){
  // load library
  try{ await loadHtml2PdfIfNeeded(); } catch(err){ console.error(err); toast('PDF library failed to load', true); return; }

  // populate print header placeholders
  fillPrintHeader();

  var root=document.getElementById('invoiceRoot');
  var prevTitle=document.title;
  document.title = (document.getElementById('invNo')||{}).value || 'Invoice';

  // Hide the on-screen top header to avoid duplication in PDF
  var topHeader = document.querySelector('.top-header');
  var prevTopHeaderDisplay = null;
  if(topHeader){
    prevTopHeaderDisplay = topHeader.style.display;
    topHeader.style.display = 'none';
  }

  // Add exporting class so print/export CSS hides controls
  document.body.classList.add('exporting');

  try{
    var safeNo=((document.getElementById('invNo')||{}).value || 'INV-0000001').replace(/[^A-Za-z0-9_-]/g,'');
    var opt={
      margin:10,
      filename:'invoice_'+(safeNo||'invoice')+'.pdf',
      image:{ type:'jpeg', quality:0.98 },
      html2canvas:{ scale:2, useCORS:true, allowTaint:true, logging:false },
      jsPDF:{ unit:'mm', format:'a4', orientation:'portrait' },
      pagebreak:{ mode:['css','legacy'] }
    };
    await window.html2pdf().set(opt).from(root).save();
  } catch(err){
    console.error(err);
    toast('PDF export failed', true);
  } finally {
    // restore UI
    document.body.classList.remove('exporting');
    if(topHeader){
      topHeader.style.display = (prevTopHeaderDisplay === null ? '' : prevTopHeaderDisplay);
    }
    document.title = prevTitle;
  }
}

/* ===== DATA ===== */
var inventory = {
  "CUCUMBER": {unit:"kg", price:1.90},
  "CORIANDER LEAVES": {unit:"kg", price:8.80},
  "MINT LEAVES": {unit:"kg", price:7.40},
  "GINGER": {unit:"box", price:9.50},
  "RAW MANGO": {unit:"kg", price:3.80}
};
var customers = {
  "Sample Customer A":"123 Test Street, Singapore 600000",
  "Sample Customer B":"45 Example Ave, Singapore 610000"
};
var paymentProfiles = {
  "Default":"Bank: DBS 012-345678-9\nPayNow UEN: 201234567A\nTerms: Net 7 days",
  "Sample Customer A":"PayNow: +65 9000 0000 (ROYAL ROOTS)",
  "Sample Customer B":"Bank: OCBC 998-765432-1, Ref: INV#"
};

var tbodyRef;

/* ===== INIT ===== */
function initInvoice(){
  tbodyRef = document.querySelector('#items tbody');

  // wire static buttons safely
  document.getElementById('btnAddRow').addEventListener('click', addRow);
  document.getElementById('btnAddProduct').addEventListener('click', addProductManually);
  document.getElementById('btnDownloadInvCSV').addEventListener('click', downloadInventoryCSV);
  document.getElementById('btnImportInv').addEventListener('click', function(){ document.getElementById('uploadInventory').click(); });
  document.getElementById('btnExportXLSX').addEventListener('click', exportInvoiceExcel);
  document.getElementById('btnClear').addEventListener('click', clearInvoice);
  document.getElementById('btnPDF').addEventListener('click', downloadPDF);
  document.getElementById('btnLogout').addEventListener('click', logout);

  document.getElementById('uploadInventory').addEventListener('change', onInventoryUpload);
  document.getElementById('uploadCustomers').addEventListener('change', onCustomersUpload);
  var upPay=document.getElementById('uploadPayments'); if(upPay){ upPay.addEventListener('change', onPaymentsUpload); }
  rebuildPaymentDropdown();
  rebuildCustomerDropdown();

  if(!tbodyRef.children.length) addRow();
  refresh();
}

/* ===== HELPERS ===== */
function money(n){ return '$'+(Number(n)||0).toFixed(2); }
function optionsHTML(){ return Object.keys(inventory).sort().map(function(p){return '<option value="'+p+'">'+p+'</option>';}).join(''); }

/* ===== ROW MANAGEMENT (safe template literal) ===== */
function addRow(){
  if(!tbodyRef) tbodyRef=document.querySelector('#items tbody');
  var tr=document.createElement('tr');

  tr.innerHTML = `
    <td class="idx"></td>
    <td>
      <select class="desc"><option value="">-- Select Product --</option>${optionsHTML()}</select>
      <span class="descPrint" style="display:none"></span>
    </td>
    <td class="center"><input type="number" class="qty center" min="0" step="0.01" value="1" style="width:50px; text-align:center"></td>
    <td class="unit center"></td>
    <td class="center"><input type="number" class="price center" min="0" step="0.01" value="0" style="width:80px; text-align:center"></td>
    <td class="num total center">$0.00</td>
    <td><button class="del-row">Ã—</button></td>
  `;

  tbodyRef.appendChild(tr);

  // wire events for this row
  var desc = tr.querySelector('.desc');
  var qty = tr.querySelector('.qty');
  var price = tr.querySelector('.price');
  var del = tr.querySelector('.del-row');

  if(desc) desc.addEventListener('change', function(){ lookupProduct(desc); });
  if(qty) qty.addEventListener('input', refresh);
  if(price) price.addEventListener('input', refresh);
  if(del) del.addEventListener('click', function(){ tr.remove(); refresh(); });

  // ensure the row reflects any default data
  refresh();
}

function lookupProduct(select){
  var tr = select.closest('tr');
  var val = select.value;
  if(inventory[val]){
    tr.querySelector('.unit').textContent = inventory[val].unit;
    tr.querySelector('.price').value = inventory[val].price;
  } else {
    tr.querySelector('.unit').textContent = '';
    tr.querySelector('.price').value = 0;
  }
  tr.querySelector('.descPrint').textContent = val;
  refresh();
}

/* ===== NEW: Add Product Manually (non-breaking) ===== */
function addProductManually(){
  // simple prompt flow: name, unit, price
  var name = (prompt('Enter product name (e.g. "BANANA")')||'').trim();
  if(!name){ toast('Product creation cancelled'); return; }
  if(inventory[name]){
    if(!confirm('Product "'+name+'" already exists. Overwrite?')){ toast('No changes made'); return; }
  }
  var unit = (prompt('Enter unit / UOM (e.g. kg, box, pcs)', 'kg')||'').trim();
  var priceStr = (prompt('Enter unit price (numeric, e.g. 3.50)','0')||'').trim();
  var price = parseFloat(priceStr);
  if(isNaN(price)){
    toast('Invalid price â€” product not added', true); return;
  }
  inventory[name] = { unit: unit, price: price };
  rebuildInventoryDropdowns();
  toast('Product "'+name+'" added');
}

/* ===== REFRESH totals ===== */
function refresh(){
  if(!tbodyRef) return;
  var sub=0;
  Array.prototype.forEach.call(tbodyRef.children, function(tr, i){
    var idxEl = tr.querySelector('.idx');
    if(idxEl) idxEl.textContent = i+1;
    var qty = parseFloat( (tr.querySelector('.qty')||{}).value ) || 0;
    var unitPrice = parseFloat( (tr.querySelector('.price')||{}).value ) || 0;
    var total = qty * unitPrice;
    sub += total;
    var totalEl = tr.querySelector('.total');
    if(totalEl) totalEl.textContent = money(total);
  });
  var gst = sub * 0.09;
  var grand = sub + gst;
  document.getElementById('subTotal').textContent = money(sub);
  document.getElementById('gstAmount').textContent = money(gst);
  document.getElementById('grandTotal').textContent = 'SGD ' + money(grand).replace(/^\$/,'');
  document.getElementById('amountWords').textContent = 'Amount in words: SGD ' + toWords(grand);
}

/* ===== CLEAR ===== */
function clearInvoice(){
  if(!tbodyRef) tbodyRef = document.querySelector('#items tbody');
  tbodyRef.innerHTML = '';
  document.getElementById('billTo').value = '';
  document.getElementById('billAddr').value = '';
  document.getElementById('invNo').value = 'INV-0000001';
  document.getElementById('invDate').value = '';
  addRow();
  refresh();
  toast('Invoice cleared');
}

/* ===== AMOUNT IN WORDS ===== */
function toWords(num){
  num = Math.round((Number(num) + Number.EPSILON) * 100);
  var dollars = Math.floor(num / 100);
  var cents = num % 100;
  if(dollars===0 && cents===0) return 'Zero Dollars Only';
  var ones=['','One','Two','Three','Four','Five','Six','Seven','Eight','Nine'];
  var teens=['Ten','Eleven','Twelve','Thirteen','Fourteen','Fifteen','Sixteen','Seventeen','Eighteen','Nineteen'];
  var tens=['','','Twenty','Thirty','Forty','Fifty','Sixty','Seventy','Eighty','Ninety'];
  function m(n){return n>=1e6? m(Math.floor(n/1e6))+' Million '+t(n%1e6):t(n);}
  function t(n){return n>=1e3? h(Math.floor(n/1e3))+' Thousand '+h(n%1e3):h(n);}
  function h(n){return n>99? ones[Math.floor(n/100)]+' Hundred '+u(n%1e2):u(n);}
  function u(n){return n<10?ones[n]:(n<20?teens[n-10]:tens[Math.floor(n/10)]+' '+ones[n%10]);}
  var words = dollars>0 ? m(dollars).trim()+' Dollar'+(dollars!==1?'s':'') : '';
  if(cents>0){
    var centWords = cents<10?ones[cents]:(cents<20?teens[cents-10]:tens[Math.floor(cents/10)]+' '+ones[cents%10]);
    words += (words? ' and ':'') + centWords.trim() + ' Cent'+(cents!==1?'s':'');
  }
  return words + ' Only';
}

/* ===== CUSTOMERS ===== */
function rebuildCustomerDropdown(){
  var sel=document.getElementById('customerSelect');
  var current = sel ? sel.value : '';
  if(!sel) return;
  sel.innerHTML = '<option value="">-- Select Customer --</option>' + Object.keys(customers).sort().map(function(n){
    return '<option value="'+n+'">'+n+'</option>';
  }).join('');
  if(current && customers[current]) sel.value = current;
}
function onSelectCustomer(sel){
  var name = sel.value;
  document.getElementById('billTo').value = name || '';
  document.getElementById('billAddr').value = customers[name] || '';
  if(paymentProfiles[name]){
    var ps=document.getElementById('paymentSelect');
    if(ps) ps.value = name;
    var ta=document.getElementById('paymentDetails');
    if(ta) ta.value = paymentProfiles[name];
  }
}
function downloadCustomersCSV(){
  var csv='Name,Address\n';
  Object.keys(customers).forEach(function(n){ var a=customers[n]||''; csv += '"'+n.replace(/"/g,'""')+'","'+a.replace(/"/g,'""')+'"\n';});
  var blob=new Blob([csv],{type:'text/csv'});
  var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='customers.csv'; a.click(); URL.revokeObjectURL(a.href);
}
function onCustomersUpload(e){
  var file=e.target.files[0]; if(!file) return; var reader=new FileReader();
  reader.onload=function(){
    try{
      var rows=parseCSV(reader.result);
      if(!rows.length){ toast('CSV had no rows',true); return; }
      var headers=Object.keys(rows[0]).map(function(h){return String(h).toLowerCase();});
      var find=function(arr){ return headers.findIndex(function(h){ return arr.indexOf(h)>-1; }); };
      var iName=find(['name','customer','client']);
      var iAddr=find(['address','addr','address line']);
      if(iName<0){ toast('Missing Name column',true); return; }
      var obj={};
      rows.forEach(function(r){
        var vals=Object.values(r);
        var n=(vals[iName]||'').toString().trim(); if(!n) return;
        var a=iAddr>-1 ? (vals[iAddr]||'').toString() : '';
        obj[n]=a;
      });
      if(Object.keys(obj).length){ customers=obj; rebuildCustomerDropdown(); toast('Customers CSV imported'); }
      else toast('CSV had no valid customers',true);
    }catch(err){ console.error(err); toast('Invalid customers CSV',true); }
  };
  reader.readAsText(file);
}

/* ===== PAYMENTS ===== */
function rebuildPaymentDropdown(){
  var sel=document.getElementById('paymentSelect'); if(!sel) return;
  var current=sel.value;
  sel.innerHTML = '<option value="">-- Select Payment --</option>' + Object.keys(paymentProfiles).sort().map(function(n){ return '<option value="'+n+'">'+n+'</option>'; }).join('');
  if(current && paymentProfiles[current]) sel.value = current;
}
function onSelectPayment(sel){
  var key=sel.value; var ta=document.getElementById('paymentDetails');
  if(ta) ta.value = key && paymentProfiles[key] ? paymentProfiles[key] : (ta.value||'');
}
function downloadPaymentsCSV(){
  var csv='Name,Details\n';
  Object.keys(paymentProfiles).forEach(function(n){
    var d=(paymentProfiles[n]||'').replace(/\r?\n/g,'\n');
    csv += '"'+n.replace(/"/g,'""')+'","'+d.replace(/"/g,'""')+'"\n';
  });
  var blob=new Blob([csv],{type:'text/csv'});
  var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='payments.csv'; a.click(); URL.revokeObjectURL(a.href);
}
function onPaymentsUpload(e){
  var file=e.target.files[0]; if(!file) return; var reader=new FileReader();
  reader.onload=function(){
    try{
      var rows=parseCSV(reader.result);
      if(!rows.length){ toast('CSV had no rows',true); return; }
      var headers=Object.keys(rows[0]).map(function(h){return String(h).toLowerCase();});
      var find=function(arr){ return headers.findIndex(function(h){ return arr.indexOf(h)>-1; }); };
      var iName=find(['name','customer','profile']);
      var iDet=find(['details','payment','payment details','instructions']);
      if(iName<0||iDet<0){ toast('Missing Name/Details columns',true); return; }
      var obj={};
      rows.forEach(function(r){
        var vals=Object.values(r);
        var n=(vals[iName]||'').toString().trim(); if(!n) return;
        var d=(vals[iDet]||'').toString();
        obj[n]=d;
      });
      if(Object.keys(obj).length){ paymentProfiles=obj; rebuildPaymentDropdown(); toast('Payments CSV imported'); }
      else toast('CSV had no valid payments',true);
    }catch(err){ console.error(err); toast('Invalid payments CSV',true); }
  };
  reader.readAsText(file);
}

/* ===== CSV helpers (shared) ===== */
function splitCSVRow(row){
  var out=[], cur='', q=false;
  for(var i=0;i<row.length;i++){
    var ch=row[i];
    if(ch==='"'){ if(q && row[i+1]==='"'){ cur+='"'; i++; } else { q=!q; } }
    else if(ch===',' && !q){ out.push(cur); cur=''; }
    else { cur+=ch; }
  }
  out.push(cur);
  return out.map(function(s){ return s.trim(); });
}
function parseCSV(text){
  var lines = text.split(/\r?\n/).filter(function(l){ return l.trim().length; });
  if(!lines.length) return [];
  var headers = splitCSVRow(lines.shift()).map(function(h){ return h.replace(/^"|"$/g,''); });
  return lines.map(function(line){
    var cells = splitCSVRow(line).map(function(c){ return c.replace(/^"|"$/g,''); });
    var obj = {}; headers.forEach(function(h,i){ obj[h] = cells[i] || ''; });
    return obj;
  });
}

/* ===== INVENTORY import/export ===== */
function downloadInventoryCSV(){
  var csv='Name,Unit,Price\n';
  Object.keys(inventory).forEach(function(name){
    var v=inventory[name]||{}, unit=v.unit||'', price=v.price||0;
    csv+='"'+name.replace(/"/g,'""')+'","'+String(unit).replace(/"/g,'""')+'",'+price+'\n';
  });
  var blob=new Blob([csv],{type:'text/csv'});
  var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='inventory.csv'; a.click(); URL.revokeObjectURL(a.href);
}
function onInventoryUpload(e){
  var file=e.target.files[0]; if(!file) return; var name=file.name.toLowerCase(); var reader=new FileReader();
  if(name.endsWith('.csv')){
    reader.onload=function(){
      try{
        var rows=parseCSV(reader.result);
        var headers=Object.keys(rows[0]||{}).map(function(h){return h.toLowerCase();});
        var find=function(arr){ return headers.findIndex(function(h){ return arr.indexOf(h)>-1; }); };
        var iName=find(['name','product','item','description','item name']);
        var iUnit=find(['unit','uom','per unit']);
        var iPrice=find(['price','rate','unit price']);
        var obj={};
        rows.forEach(function(r){
          var vals=Object.values(r);
          var key=vals[iName]; if(!key) return;
          var unit=iUnit>-1? vals[iUnit] : '';
          var price=iPrice>-1? parseFloat(vals[iPrice])||0 : 0;
          obj[String(key).trim()]={unit:unit,price:price};
        });
        if(Object.keys(obj).length){ inventory=obj; rebuildInventoryDropdowns(); toast('Inventory CSV imported successfully'); }
        else toast('CSV had no valid rows', true);
      }catch(err){ console.error(err); toast('Invalid CSV', true); }
    };
    reader.readAsText(file); return;
  }
  reader.onload=function(evt){
    try{
      var bytes=new Uint8Array(evt.target.result);
      var wb=XLSX.read(bytes,{type:'array'});
      var ws=wb.Sheets[wb.SheetNames[0]];
      var rows=XLSX.utils.sheet_to_json(ws,{defval:''});
      var obj={};
      rows.forEach(function(r){
        var key=r.Name||r.Product||r.Item||r.Description||r.ItemName||r['Item Name']; if(!key) return;
        obj[String(key).trim()]={ unit:r.Unit||r.UOM||r['Per Unit']||'', price:parseFloat(r.Price||r.Rate||r['Unit Price']||0)||0 };
      });
      if(Object.keys(obj).length){ inventory=obj; rebuildInventoryDropdowns(); toast('Inventory Excel imported successfully'); }
      else toast('No valid rows in sheet', true);
    }catch(err){ console.error(err); toast('Failed to read Excel', true); }
  };
  reader.readAsArrayBuffer(file);
}
function rebuildInventoryDropdowns(){
  var html=optionsHTML();
  document.querySelectorAll('select.desc').forEach(function(sel){
    var current = sel.value;
    sel.innerHTML = '<option value="">-- Select Product --</option>' + html;
    if(inventory[current]) sel.value = current;
    sel.dispatchEvent(new Event('change'));
  });
}

/* ===== EXPORT INVOICE (Excel) ===== */
function exportInvoiceExcel(){
  var wb=XLSX.utils.book_new();
  var rows=[["#","Description","Qty","Per Unit","Unit Price ($)","Total ($)"]];
  Array.prototype.forEach.call(tbodyRef.children, function(tr){
    rows.push([
      tr.querySelector('.idx').textContent,
      tr.querySelector('.descPrint').textContent||tr.querySelector('.desc').value,
      tr.querySelector('.qty').value,
      tr.querySelector('.unit').textContent,
      tr.querySelector('.price').value,
      tr.querySelector('.total').textContent
    ]);
  });
  rows.push([]);
  rows.push(["Subtotal","","","","", document.getElementById('subTotal').textContent]);
  rows.push(["GST (9%)","","","","", document.getElementById('gstAmount').textContent]);
  rows.push(["Grand Total","","","","", document.getElementById('grandTotal').textContent]);
  var ws=XLSX.utils.aoa_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb,ws,'Invoice');
  XLSX.writeFile(wb,'invoice.xlsx');
}

/* ===== STARTUP (wire events) ===== */
window.addEventListener('DOMContentLoaded', function(){
  // login wiring
  var btnLogin = document.getElementById('loginBtn');
  if(btnLogin) btnLogin.addEventListener('click', loginHandler);
  var usr=document.getElementById('username'), pwd=document.getElementById('password');
  if(pwd) pwd.addEventListener('keydown', function(e){ if(e.key==='Enter'){ loginHandler(e); }});
  if(usr) usr.addEventListener('input', function(){ var err=document.getElementById('loginError'); if(err) err.style.display='none'; });
  if(pwd) pwd.addEventListener('input', function(){ var err=document.getElementById('loginError'); if(err) err.style.display='none'; });

  // wire other UI we use direct ids for
  document.getElementById('btnDownloadInvCSV').addEventListener('click', downloadInventoryCSV);
  document.getElementById('btnImportInv').addEventListener('click', function(){ document.getElementById('uploadInventory').click(); });

  // Auto-login if previously logged in
  if(localStorage.getItem('rr_logged_in')==='1'){ showApp(); }
  else { document.getElementById('loginPage').style.display='flex'; document.getElementById('app').style.display='none'; }

  // copy type wiring
  var csel = document.getElementById('copyTypeSelect'); if(csel) csel.addEventListener('change', updateCopyType);
  updateCopyType();
});
</script>
</body>
</html>
